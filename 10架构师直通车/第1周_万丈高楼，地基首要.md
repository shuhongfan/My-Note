Java架构师成长直通车大大课

# 课程导学

## 课程介绍

![image-20201108144423650](img/image-20201108144423650.png)![image-20201108144445412](img/image-20201108144445412.png)![image-20201108144522641](img/image-20201108144522641.png)![image-20201108144723820](img/image-20201108144723820.png)![image-20201108144812095](img/image-20201108144812095.png)![image-20201108144833317](img/image-20201108144833317.png)

## 技术栈

![image-20201108144643823](img/image-20201108144643823.png)

## 适合人群

![image-20201108145029272](img/image-20201108145029272.png)

## 讲师团队

![image-20201108145132042](img/image-20201108145132042.png)![image-20201108145304509](img/image-20201108145304509.png)![image-20201108145413021](img/image-20201108145413021.png)![image-20201108145528762](img/image-20201108145528762.png)![image-20201108145700134](img/image-20201108145700134.png)![image-20201108145901006](img/image-20201108145901006.png)![image-20201108150024809](img/image-20201108150024809.png)

## 课程安排

![image-20201108150209267](img/image-20201108150209267.png)![image-20201108150233058](img/image-20201108150233058.png)

## 阶段任务

### 阶段一 单体项目开发与上线

![image-20201108150333947](img/image-20201108150333947.png)![image-20201108150400380](img/image-20201108150400380.png)

### 阶段二 单体架构到高可用集群

![image-20201108150602931](img/image-20201108150602931.png)

### 阶段三 击破分布式核心问题

![image-20201108150634010](img/image-20201108150634010.png)![image-20201108150930404](img/image-20201108150930404.png)![image-20201108151440372](img/image-20201108151440372.png)

### 阶段四 SpringCloud G版微服务

![image-20201108151540984](img/image-20201108151540984.png)![image-20201108151640347](img/image-20201108151640347.png)![image-20201108151757513](img/image-20201108151757513.png)

### 阶段五 Docker,K8S容器化

![image-20201108152015734](img/image-20201108152015734.png)![image-20201108152307170](img/image-20201108152307170.png)

### 阶段六 Netty与性能调优

![image-20201108152532086](img/image-20201108152532086.png)![image-20201108152713152](img/image-20201108152713152.png)![image-20201108152735483](img/image-20201108152735483.png)

# 大型网站架构演进历程

## 大型网站特点

>高并发
>高可用
>大数据
>迭代周期短
>用户量庞大
>可持续发展
>安全级别高
>可弹性、可伸缩  

## 大型网站演进

### 静态网站

![image-20201108152957027](img/image-20201108152957027.png)![image-20201108153013680](img/image-20201108153013680.png)

### 单体架构

![image-20201108153533697](img/image-20201108153533697.png)

### 分离架构

![image-20201108153657847](img/image-20201108153657847.png)

### 缓存引入

![image-20201108153855577](img/image-20201108153855577.png)

### 集群引入

![image-20201108154247811](img/image-20201108154247811.png)

### 读写分离

![image-20201108154431077](img/image-20201108154431077.png)

### 分库分表

![image-20201108154601254](img/image-20201108154601254.png)

### 抽取搜索

![image-20201108154751393](img/image-20201108154751393.png)

### 垂直拆分

![image-20201108154853750](img/image-20201108154853750.png)

### 抽取服务

![image-20201108155211473](img/image-20201108155211473.png)

# 架构师

## 技术栈

![pic](img/pic.png)

## 能力

![image-20201108155713412](img/image-20201108155713412.png)![image-20201108155748172](img/image-20201108155748172.png)![image-20201108155911409](img/image-20201108155911409.png)

# 单体架构阶段概述与项目演示

## 概述

![image-20201108160355657](img/image-20201108160355657.png)

## 架构设计与准备

![image-20201108160532738](img/image-20201108160532738.png)![image-20201108160822518](img/image-20201108160822518.png)

## 项目演示

> 地址:shop.t.mukewang.com
>
> 主要功能:
>
> - 轮播图 --跳转到具体或者某一类商品
> - 三级分类展示--懒加载模式
> - 分类商品推荐--滚动加载(懒加载)
> - 商品详情.购物车(登录未登录),结算
> - 搜索,分页,排序
> - 收货地址
> - 微信,支付宝支付
> - 个人中心等

## 技术选型

### 考虑因素



### 后![image-20201108164101669](img/image-20201108164101669.png)端

![image-20201108161912810](img/image-20201108161912810.png)![image-20201108162330226](img/image-20201108162330226.png)

### 前端

![image-20201108162656398](img/image-20201108162656398.png)



## 前后端分离开发模式

### 传统Web开发

![image-20201108170104691](img/image-20201108170104691.png)

### MVVM开发模式

![image-20201108171102477](img/image-20201108171102477.png)

## 项目分层设计

### 拆分聚合

![image-20201108171408026](img/image-20201108171408026.png)

### Maven拆分聚合

![image-20201108171802455](img/image-20201108171802455.png)

## IDEA搭建聚合工程

> 打包方式:父工程pom,web工程war,其他jar,默认jar
>
> 依赖传递:parent--common--pojo--Mapper--services--api
>
> 建立关系:构建完项目执行install

### 父工程搭建

![image-20201108175022151](img/image-20201108175022151.png)![image-20201108175106354](img/image-20201108175106354.png)![image-20201108175258739](img/image-20201108175258739.png)![image-20201108175345643](img/image-20201108175345643.png)

### 子工程搭建

![image-20201108182002226](img/image-20201108182002226.png)![image-20201108182028764](img/image-20201108182028764.png)![image-20201108182046570](img/image-20201108182046570.png)

### 项目结构

![image-20201108184713398](img/image-20201108184713398.png)

## 数据库建模PDMan

![image-20201108185959067](img/image-20201108185959067.png)

### 介绍

> 官网:www.pdman.cn
>
> 功能:数据库设计,版本管理,生成代码,同步更新数据库
>
> 界面:
>
> ![image-20201108191016427](img/image-20201108191016427.png)
>
> ![image-20201108190913942](img/image-20201108190913942.png)
>
> 设置:
>
> ![image-20201108191114511](img/image-20201108191114511.png)
>
> 表功能:
>
> ![image-20201108191528624](img/image-20201108191528624.png)
>
> 表关系展示:
>
> ![image-20201108191744980](img/image-20201108191744980.png)![image-20201108193228185](img/image-20201108193228185.png)
>
> 连接数据库并推送表到数据库:
>
> ![image-20201108193618036](img/image-20201108193618036.png)
>
> ![image-20201108200507182](img/image-20201108200507182.png)

### 增量更新同步

> ![image-20201108201151237](img/image-20201108201151237.png)![image-20201108201418076](img/image-20201108201418076.png)![image-20201108201701286](img/image-20201108201701286.png)

### 外检移除

![image-20201108201815448](img/image-20201108201815448.png)

# 聚合工程整合SpringBoot

> maven 库  :https://mvnrepository.com/  

## 整合步骤

> 父工程POM中:
>
> ![image-20201108210817436](img/image-20201108210817436.png)
>
> ![image-20201108204814078](img/image-20201108204814078.png)

### 引入依赖 parent  

```xml
<parent>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-parent</artifactId>
	<version>2.1.5.RELEASE</version>
	<relativePath />
</parent>
```

### 设置资源属性  

```xml
<properties>
	<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
	<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
	<java.version>1.8</java.version>
</properties>
```

### 引入依赖 dependency  

```xml
<dependencies>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter</artifactId>
		<exclusions>
			<exclusion>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-logging</artifactId>
			</exclusion>
		</exclusions>
	</dependency>
	<dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-web</artifactId>
	</dependency>
	<--用于解析xml和properties配置文件-->
    <dependency>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-configuration-processor</artifactId>
			<optional>true</optional>
	</dependency>
</dependencies>
```

### 项目结构

![image-20201108210653207](img/image-20201108210653207.png)![image-20201108210925112](img/image-20201108210925112.png)

## SpringBoot自动装配

> 根据引入的依赖去META-INF/spring.factories文件中找到默认配置

### run方法

![image-20201108211200711](img/image-20201108211200711.png)![image-20201108211242510](img/image-20201108211242510.png)

### @SpringBootApplication

> 组合注解:包扫描,自动配置,配置类(启动类下一级所有配置类都能扫描到)

![image-20201108211359560](img/image-20201108211359560.png)

### @EnableAutoConfiguration

![image-20201108211639169](img/image-20201108211639169.png)

### AutoConfigurationImportSelector

![image-20201108212103809](img/image-20201108212103809.png)![image-20201108212156703](img/image-20201108212156703.png)![image-20201108212255946](img/image-20201108212255946.png)![image-20201108212806700](img/image-20201108212806700.png)

## 整合HiKariCP

> SpringBoot默认数据库连接池就是HiKariCP
>
> 在父工程pom
>
> **![image-20201108214844108](img/image-20201108214844108.png)**
>
> yaml配置放在api工程

### 引入数据源驱动与mybatis依赖  

```xml
<!-- mysql驱动 -->
<dependency>
	<groupId>mysql</groupId>
	<artifactId>mysql-connector-java</artifactId>
	<version>5.1.41</version>
</dependency>
<!-- mybatis -->
<dependency>
	<groupId>org.mybatis.spring.boot</groupId>
	<artifactId>mybatis-spring-boot-starter</artifactId>
	<version>2.1.0</version>
</dependency>
```

### yml中配置数据源和mybatis  

```properties
############################################################
# #
配置数据源信息
# #
###########################################################
spring:
datasource: # 数据源的相关配置
type: com.zaxxer.hikari.HikariDataSource # 数据源类型：HikariCP
driver-class-name: com.mysql.jdbc.Driver # mysql驱动
url: jdbc:mysql://localhost:3306/foodie-shop-dev?useUnicode=true&characterEncoding=UTF-8&autoReconnect
username: root
password: root
hikari:
connection-timeout: 30000 # 等待连接池分配连接的最大时长（毫秒），超过这个时长还没可用的连接则发生SQ
minimum-idle: 5 # 最小连接数
maximum-pool-size: 20 # 最大连接数
auto-commit: true # 自动提交
idle-timeout: 600000 # 连接超时的最大时长（毫秒），超时则被释放（retired），默认:10分钟
pool-name: DateSourceHikariCP # 连接池名字
max-lifetime: 1800000 # 连接的生命时长（毫秒），超时而且没被使用则被释放（retired），默认:30分钟
connection-test-query: SELECT 1
############################################################
# #
mybatis 配置
# #
###########################################################
mybatis:
type-aliases-package: com.imooc.pojo # 所有POJO类所在包路径
mapper-locations: classpath:mapper/*.xml # mapper映射文件
```

### 内置tomcat  

```properties
############################################################
# #
web访问端口号 约定：8088
```

# Mybatis逆向工程

> 本版本是通用Mapper版的逆向工程
>
> ![image-20201108215439893](img/image-20201108215439893.png)

## 使用步骤

> 在父工程里面引用就可以,配置在api工程
>
> 再把逆向工程的MyMapper拷贝到目的工程才能使用生成的mapper
>
> ![image-20201108220539080](img/image-20201108220539080.png)

### 在pom中引入通用mapper工具  

```xml
<!-- 通用mapper逆向工具 -->
<dependency>
	<groupId>tk.mybatis</groupId>
	<artifactId>mapper-spring-boot-starter</artifactId>
	<version>2.1.5</version>
</dependency>
```

### yml中引入通用mapper配置  

```properties
############################################################
# #
mybatis mapper 配置
# #
###########################################################
# 通用 Mapper 配置
mapper:
mappers: com.imooc.my.mapper.MyMapper
not-empty: false
identity: MYSQL
```

### 引入MyMapper接口类  

```java
package com.imooc.my.mapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.MySqlMapper;
/**
* 继承自己的MyMapper
*/
public interface MyMapper<T> extends Mapper<T>, MySqlMapper<T> {
}
```

## 通用Mapper接口常用方法  

![image-20201108220719667](img/image-20201108220719667.png)![image-20201108220835765](img/image-20201108220835765.png)

![image-20201108220902273](img/image-20201108220902273.png)![image-20201108220943012](img/image-20201108220943012.png)

# Restful风格

## 介绍

![image-20201108221159788](img/image-20201108221159788.png)

## 设计规范

![image-20201108221324595](img/image-20201108221324595.png)

## 通用Mapper的Restful风格CRUD

### Controler

```java
package com.imooc.controller;

import com.imooc.service.StuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;
import springfox.documentation.annotations.ApiIgnore;

//@Controller
@ApiIgnore
@RestController
public class StuFooController {

    @Autowired
    private StuService stuService;

    @GetMapping("/getStu")
    public Object getStu(int id) {
        return stuService.getStuInfo(id);
    }

    @PostMapping("/saveStu")
    public Object saveStu() {
        stuService.saveStu();
        return "OK";
    }

    @PostMapping("/updateStu")
    public Object updateStu(int id) {
        stuService.updateStu(id);
        return "OK";
    }

    @PostMapping("/deleteStu")
    public Object deleteStu(int id) {
        stuService.deleteStu(id);
        return "OK";
    }

}

```

### Service

```java
package com.imooc.service.impl;

import com.imooc.mapper.StuMapper;
import com.imooc.pojo.Stu;
import com.imooc.service.StuService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

@Service
public class StuServiceImpl implements StuService {

    @Autowired
    public StuMapper stuMapper;

    @Transactional(propagation = Propagation.SUPPORTS)
    @Override
    public Stu getStuInfo(int id) {
        return stuMapper.selectByPrimaryKey(id);
    }

    @Transactional(propagation = Propagation.REQUIRED)
    @Override
    public void saveStu() {

        Stu stu = new Stu();
        stu.setName("jack");
        stu.setAge(19);
        stuMapper.insert(stu);
    }

    @Transactional(propagation = Propagation.REQUIRED)
    @Override
    public void updateStu(int id) {

        Stu stu = new Stu();
        stu.setId(id);
        stu.setName("lucy");
        stu.setAge(20);
        stuMapper.updateByPrimaryKey(stu);
    }

    @Transactional(propagation = Propagation.REQUIRED)
    @Override
    public void deleteStu(int id) {
        stuMapper.deleteByPrimaryKey(id);
    }



    public void saveParent() {
        Stu stu = new Stu();
        stu.setName("parent");
        stu.setAge(19);
        stuMapper.insert(stu);
    }
    @Transactional(propagation = Propagation.REQUIRED)
    public void saveChildren() {
        saveChild1();
        int a = 1 / 0;
        saveChild2();
    }

    public void saveChild1() {
        Stu stu1 = new Stu();
        stu1.setName("child-1");
        stu1.setAge(11);
        stuMapper.insert(stu1);
    }
    public void saveChild2() {
        Stu stu2 = new Stu();
        stu2.setName("child-2");
        stu2.setAge(22);
        stuMapper.insert(stu2);
    }
}
```

### Mapper

```java
package com.imooc.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Stu;

public interface StuMapper extends MyMapper<Stu> {
}
```

## PostMan测试接口

![image-20201108224626812](img/image-20201108224626812.png)![image-20201108225937157](img/image-20201108225937157.png)![image-20201108230848513](img/image-20201108230848513.png)![image-20201108230945391](img/image-20201108230945391.png)

# 事物

## 事物的传播行为

![image-20201108231134365](img/image-20201108231134365.png)![image-20201108231227235](img/image-20201108231227235.png)![image-20201108231249020](img/image-20201108231249020.png)![image-20201108231506110](img/image-20201108231506110.png)

## @EnableTransactionManaget

> 为什么不用开企鹅啊3事物也能使用事物,因为SpringBoot的自动装配
>
> ![image-20201108231936102](img/image-20201108232059911.png)

# 单体电商核心功能

![image-20201108232532957](img/image-20201108232532957.png)![image-20201108232607629](img/image-20201108232607629.png)![image-20201108232628370](img/image-20201108232628370.png)





# 注册功能

## 常见注册登录流程

### 用户名注册登录

![image-20201108235444732](img/image-20201108235444732.png)

### 邮箱注册流程

![image-20201108235807252](img/image-20201108235807252.png)

### 手机号注册登录

![image-20201108235939200](img/image-20201108235939200.png)

## 页面

```html
<div class="login-box">

						<div class="am-tabs" id="doc-my-tabs">
							<ul class="am-tabs-nav am-nav am-nav-tabs am-nav-justify">
								<li class="am-active"><a href="">用户注册</a></li>
								<!-- <li><a href=""></a></li> -->
								<!-- <li><a href="">手机号注册</a></li> -->
							</ul>

							<div class="am-tabs-bd" id="regist">
								<div class="am-tab-panel am-active">
									<form method="post">
										
										<div class="user-email">
											<label for="username"><i class="am-icon-envelope-o"></i></label>
											<input id="username" v-model="username" placeholder="请输入用户名">
										</div>
										<div v-show="errUsernameIsShow" style="padding: 10px;font-size: 12px;color: red;">
											{{errUsername}}
										</div>										
										<div class="user-pass">
											<label for="password"><i class="am-icon-lock"></i></label>
											<input type="password" id="password" v-model="password" placeholder="设置密码">
										</div>										
										<div class="user-pass">
											<label for="confirmPassword"><i class="am-icon-lock"></i></label>
											<input type="password" id="confirmPassword" v-model="confirmPassword" placeholder="确认密码">
										</div>
									
										<div class="login-links">
											<a :href="'login.html?returnUrl=' + returnUrl" class="am-fr">已有账号？去登录</a>
											<br />
										</div>
										<div class="am-cf">
											<input type="button" name="" value="注册" @click="registUser" class="am-btn am-btn-primary am-btn-sm am-fl">
										</div>
									</form>
								</div>
							</div>
						</div>

				</div>
			</div>
```

## JS

```js
<script type="text/javascript " src="js/app.js"></script>
		<script type="text/javascript">
			var index = new Vue({
				el: "#regist",
				data: {
					username: null,
					password: null,
					confirmPassword: null,

					errUsername: null,
					errUsernameIsShow: false,

					returnUrl: ""
				},
				created() {

					// 注册成功后会跳原来页面
					var returnUrl = app.getUrlParam("returnUrl");
					if (returnUrl != null && returnUrl != undefined && returnUrl != '') {
						this.returnUrl = returnUrl;
					}
				},
				watch: {
					username: function() {
						var serverUrl = app.serverUrl;
						var username = this.username;
						// console.log(this.username);
						axios.get(serverUrl + '/passport/usernameIsExist?username=' + username, {})
							.then(res => {
								if (res.data.status == 200) {
									this.errUsername = null;
									this.errUsernameIsShow = false;
									return;
								} else if (res.data.status == 500) {
									this.errUsername = res.data.msg;
									this.errUsernameIsShow = true;
									return;
								}
							});
					}
				},
				methods: {
					getRequest() {
					},
					postRequest() {							
					},
					// usernameIsExist() {
					// 	console.log(this.username);
					// },
					registUser() {

						if (this.username == null || this.username == undefined || this.username =='') {
							alert("用户名不能为空");
							return;
						} else if (this.password == null || this.password == undefined || this.password =='') {
							alert("密码不能为空");
							return;
						} else if (this.password.length < 6) {
							alert("密码不能少于6位");
							return;
						} else if (this.confirmPassword == null || this.confirmPassword == undefined || this.confirmPassword =='') {
							alert("确认密码不能为空");
							return;
						} else if (this.confirmPassword != this.password) {
							alert("密码与确认密码不一致");
							return;
						}

						var userBO = {
							username: this.username,
							password: this.password,
							confirmPassword: this.confirmPassword
						};
						// console.log(userBO);

						var serverUrl = app.serverUrl;
						var returnUrl = this.returnUrl;
						// form提交
						axios.defaults.withCredentials = true;
						// console.log(axios.defaults);
						axios.post(serverUrl + '/passport/regist', userBO)
							.then(res => {
								if (res.data.status == 200) {
									var user = res.data;
									// console.log(user);
									// window.location.href = app.ctx + "/index.html";
									// window.location.href = "index.html";

									if (returnUrl != null && returnUrl != undefined && returnUrl != '') {
										window.location.href = returnUrl;
									} else {
										window.location.href = "index.html";
									}

								} else if (res.data.status == 500) {
									alert(res.data.msg);
									return;
								}
							});
					}
				}
			});
		</script>
```

## 自定义响应数据结构

> 状态码还可以优化成枚举类,为了归类管理

```java
package com.imooc.utils;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.databind.ObjectMapper;

/**
 * 
 * @Title: IMOOCJSONResult.java
 * @Package com.imooc.utils
 * @Description: 自定义响应数据结构
 * 				本类可提供给 H5/ios/安卓/公众号/小程序 使用
 * 				前端接受此类数据（json object)后，可自行根据业务去实现相关功能
 * 
 * 				200：表示成功
 * 				500：表示错误，错误信息在msg字段中
 * 				501：bean验证错误，不管多少个错误都以map形式返回
 * 				502：拦截器拦截到用户token出错
 * 				555：异常抛出信息
 * 				556: 用户qq校验异常
 * @Copyright: Copyright (c) 2020
 * @Company: www.imooc.com
 * @author 慕课网 - 风间影月
 * @version V1.0
 */
public class IMOOCJSONResult {

    // 定义jackson对象
    private static final ObjectMapper MAPPER = new ObjectMapper();

    // 响应业务状态
    private Integer status;

    // 响应消息
    private String msg;

    // 响应中的数据
    private Object data;
    
    @JsonIgnore
    private String ok;	// 不使用

    public static IMOOCJSONResult build(Integer status, String msg, Object data) {
        return new IMOOCJSONResult(status, msg, data);
    }

    public static IMOOCJSONResult build(Integer status, String msg, Object data, String ok) {
        return new IMOOCJSONResult(status, msg, data, ok);
    }
    
    public static IMOOCJSONResult ok(Object data) {
        return new IMOOCJSONResult(data);
    }

    public static IMOOCJSONResult ok() {
        return new IMOOCJSONResult(null);
    }
    
    public static IMOOCJSONResult errorMsg(String msg) {
        return new IMOOCJSONResult(500, msg, null);
    }
    
    public static IMOOCJSONResult errorMap(Object data) {
        return new IMOOCJSONResult(501, "error", data);
    }
    
    public static IMOOCJSONResult errorTokenMsg(String msg) {
        return new IMOOCJSONResult(502, msg, null);
    }
    
    public static IMOOCJSONResult errorException(String msg) {
        return new IMOOCJSONResult(555, msg, null);
    }
    
    public static IMOOCJSONResult errorUserQQ(String msg) {
        return new IMOOCJSONResult(556, msg, null);
    }

    public IMOOCJSONResult() {

    }

    public IMOOCJSONResult(Integer status, String msg, Object data) {
        this.status = status;
        this.msg = msg;
        this.data = data;
    }
    
    public IMOOCJSONResult(Integer status, String msg, Object data, String ok) {
        this.status = status;
        this.msg = msg;
        this.data = data;
        this.ok = ok;
    }

    public IMOOCJSONResult(Object data) {
        this.status = 200;
        this.msg = "OK";
        this.data = data;
    }

    public Boolean isOK() {
        return this.status == 200;
    }

    public Integer getStatus() {
        return status;
    }

    public void setStatus(Integer status) {
        this.status = status;
    }

    public String getMsg() {
        return msg;
    }

    public void setMsg(String msg) {
        this.msg = msg;
    }

    public Object getData() {
        return data;
    }

    public void setData(Object data) {
        this.data = data;
    }

	public String getOk() {
		return ok;
	}

	public void setOk(String ok) {
		this.ok = ok;
	}

}
```

## 判断用户名是否存在

> 可以通过离开光标事件或者vue监测值变化向厚端发起请求

### 前端

```js
watch: {
					username: function() {
						var serverUrl = app.serverUrl;
						var username = this.username;
						// console.log(this.username);
						axios.get(serverUrl + '/passport/usernameIsExist?username=' + username, {})
							.then(res => {
								if (res.data.status == 200) {
									this.errUsername = null;
									this.errUsernameIsShow = false;
									return;
								} else if (res.data.status == 500) {
									this.errUsername = res.data.msg;
									this.errUsernameIsShow = true;
									return;
								}
							});
					}
				},
```



### 后端

#### Controler

```JAVA
@Api(value = "注册登录", tags = {"用于注册登录的相关接口"})
@RestController
@RequestMapping("passport")
public class PassportController {

    @Autowired
    private UserService userService;

    @ApiOperation(value = "用户名是否存在", notes = "用户名是否存在", httpMethod = "GET")
    @GetMapping("/usernameIsExist")
    public IMOOCJSONResult usernameIsExist(@RequestParam String username) {

        // 1. 判断用户名不能为空
        if (StringUtils.isBlank(username)) {
            return IMOOCJSONResult.errorMsg("用户名不能为空");
        }

        // 2. 查找注册的用户名是否存在
        boolean isExist = userService.queryUsernameIsExist(username);
        if (isExist) {
            return IMOOCJSONResult.errorMsg("用户名已经存在");
        }

        // 3. 请求成功，用户名没有重复
        return IMOOCJSONResult.ok();
    }
}
```

#### Services

```java
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    public UsersMapper usersMapper;

    @Autowired
    private Sid sid;

    private static final String USER_FACE = "http://122.152.205.72:88/group1/M00/00/05/CpoxxFw_8_qAIlFXAAAcIhVPdSg994.png";

    @Transactional(propagation = Propagation.SUPPORTS)
    @Override
    public boolean queryUsernameIsExist(String username) {

        Example userExample = new Example(Users.class);
        Example.Criteria userCriteria = userExample.createCriteria();

        userCriteria.andEqualTo("username", username);

        Users result = usersMapper.selectOneByExample(userExample);

        return result == null ? false : true;
    }
}
```

#### Dao

```java
package com.imooc.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Users;

public interface UsersMapper extends MyMapper<Users> {
}
```

## 实现注册功能

> 单击事件提交表单到后台

### 前端

```js
methods: {
					getRequest() {
					},
					postRequest() {							
					},
					// usernameIsExist() {
					// 	console.log(this.username);
					// },
					registUser() {

						if (this.username == null || this.username == undefined || this.username =='') {
							alert("用户名不能为空");
							return;
						} else if (this.password == null || this.password == undefined || this.password =='') {
							alert("密码不能为空");
							return;
						} else if (this.password.length < 6) {
							alert("密码不能少于6位");
							return;
						} else if (this.confirmPassword == null || this.confirmPassword == undefined || this.confirmPassword =='') {
							alert("确认密码不能为空");
							return;
						} else if (this.confirmPassword != this.password) {
							alert("密码与确认密码不一致");
							return;
						}

						var userBO = {
							username: this.username,
							password: this.password,
							confirmPassword: this.confirmPassword
						};
						// console.log(userBO);

						var serverUrl = app.serverUrl;
						var returnUrl = this.returnUrl;
						// form提交
						axios.defaults.withCredentials = true;
						// console.log(axios.defaults);
						axios.post(serverUrl + '/passport/regist', userBO)
							.then(res => {
								if (res.data.status == 200) {
									var user = res.data;
									// console.log(user);
									// window.location.href = app.ctx + "/index.html";
									// window.location.href = "index.html";

									if (returnUrl != null && returnUrl != undefined && returnUrl != '') {
										window.location.href = returnUrl;
									} else {
										window.location.href = "index.html";
									}

								} else if (res.data.status == 500) {
									alert(res.data.msg);
									return;
								}
							});
					}
				}
```



### 后端

#### Controler

```JAVA
@ApiOperation(value = "用户注册", notes = "用户注册", httpMethod = "POST")
    @PostMapping("/regist")
    public IMOOCJSONResult regist(@RequestBody UserBO userBO,
                                  HttpServletRequest request,
                                  HttpServletResponse response) {

        String username = userBO.getUsername();
        String password = userBO.getPassword();
        String confirmPwd = userBO.getConfirmPassword();

        // 0. 判断用户名和密码必须不为空
        if (StringUtils.isBlank(username) ||
                StringUtils.isBlank(password) ||
                StringUtils.isBlank(confirmPwd)) {
            return IMOOCJSONResult.errorMsg("用户名或密码不能为空");
        }

        // 1. 查询用户名是否存在
        boolean isExist = userService.queryUsernameIsExist(username);
        if (isExist) {
            return IMOOCJSONResult.errorMsg("用户名已经存在");
        }

        // 2. 密码长度不能少于6位
        if (password.length() < 6) {
            return IMOOCJSONResult.errorMsg("密码长度不能少于6");
        }

        // 3. 判断两次密码是否一致
        if (!password.equals(confirmPwd)) {
            return IMOOCJSONResult.errorMsg("两次密码输入不一致");
        }

        // 4. 实现注册
        Users userResult = userService.createUser(userBO);

        userResult = setNullProperty(userResult);

        CookieUtils.setCookie(request, response, "user",
                JsonUtils.objectToJson(userResult), true);

        // TODO 生成用户token，存入redis会话
        // TODO 同步购物车数据

        return IMOOCJSONResult.ok();
    }
```

#### Services

```java
 @Transactional(propagation = Propagation.REQUIRED)
    @Override
    public Users createUser(UserBO userBO) {

//        try {
//            Thread.sleep(3500);
//        } catch (InterruptedException e) {
//            e.printStackTrace();
//        }

        String userId = sid.nextShort();

        Users user = new Users();
        user.setId(userId);
        user.setUsername(userBO.getUsername());
        try {
            user.setPassword(MD5Utils.getMD5Str(userBO.getPassword()));
        } catch (Exception e) {
            e.printStackTrace();
        }
        // 默认用户昵称同用户名
        user.setNickname(userBO.getUsername());
        // 默认头像
        user.setFace(USER_FACE);
        // 默认生日
        user.setBirthday(DateUtil.stringToDate("1900-01-01"));
        // 默认性别为 保密
        user.setSex(Sex.secret.type);

        user.setCreatedTime(new Date());
        user.setUpdatedTime(new Date());

        usersMapper.insert(user);

        return user;
    }
```

#### Dao

```java
package com.imooc.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Users;

public interface UsersMapper extends MyMapper<Users> {
}
```

# 登录及页面显示用户信息

## 页面

```html
<div class="login-boxtitle">
		<a href="index.html"><img alt="logo" src="images/logobig.png" /></a>
	</div>

	<div class="login-banner" id="login">
		<div class="login-main">
			<div class="login-banner-bg"><span></span><img src="img/loginpage.png" /></div>
			<div class="login-box">

				<h3 class="title">登录商城</h3>
				<div class="clear"></div>
				<div class="login-form">
					<form>
						<div class="user-name">
							<label for="user"><i class="am-icon-user"></i></label>
							<input type="text" v-model="username" id="user" placeholder="请输入用户名">
						</div>
						<div class="user-pass">
							<label for="password"><i class="am-icon-lock"></i></label>
							<input type="password" v-model="password" id="password" placeholder="请输入密码">
						</div>
					</form>
				</div>

				<div class="login-links">
					<a :href="'register.html?returnUrl=' + returnUrl" class="am-fr">前往注册</a>
					<br />
				</div>
				<div class="am-cf">
					<input type="button" name="" value="登 录" @click="doLogin" class="am-btn am-btn-primary am-btn-sm">
				</div>
			</div>
		</div>
	</div>

```

## JS

```js
<script type="text/javascript " src="js/app.js"></script>
	<script type="text/javascript">
		var index = new Vue({
			el: "#login",
			data: {
				username: null,
				password: null,

				returnUrl: ""
			},
			created() {
				
				// 登录成功后会跳原来页面
				var returnUrl = app.getUrlParam("returnUrl");
				if (returnUrl != null && returnUrl != undefined && returnUrl != '') {
					this.returnUrl = returnUrl;
				}
			},
			methods: {
				getRequest() {
				},
				postRequest() {							
				},
				doLogin() {

					if (this.username == null || this.username == undefined || this.username == '') {
						alert("用户名不能为空");
						return;
					} else if (this.password == null || this.password == undefined || this.password == '') {
						alert("密码不能为空");
						return;
					} else if (this.password.length < 6) {
						alert("密码不能少于6位");
						return;
					}

					var userBO = {
						username: this.username,
						password: this.password
					};
					// console.log(userBO);

					var serverUrl = app.serverUrl;

					var returnUrl = this.returnUrl;
					// form提交
					axios.defaults.withCredentials = true;
					// console.log(axios.defaults);
					axios.post(serverUrl + '/passport/login', userBO)
						.then(res => {
							if (res.data.status == 200) {
								var user = res.data;
								// console.log(user);

								// window.location.href = app.ctx + "/index.html";
								if (returnUrl != null && returnUrl != undefined && returnUrl != '') {
									window.location.href = returnUrl;
								} else {
									window.location.href = "index.html";
								}

							} else if (res.data.status == 500) {
								alert(res.data.msg);
								return;
							}
						});
				}
			}
		});
	</script>
```

## 后端

### Controler

```JAVA
 @ApiOperation(value = "用户登录", notes = "用户登录", httpMethod = "POST")
    @PostMapping("/login")
    public IMOOCJSONResult login(@RequestBody UserBO userBO,
                                 HttpServletRequest request,
                                 HttpServletResponse response) throws Exception {

        String username = userBO.getUsername();
        String password = userBO.getPassword();

        // 0. 判断用户名和密码必须不为空
        if (StringUtils.isBlank(username) ||
                StringUtils.isBlank(password)) {
            return IMOOCJSONResult.errorMsg("用户名或密码不能为空");
        }

        // 1. 实现登录
        Users userResult = userService.queryUserForLogin(username,
                    MD5Utils.getMD5Str(password));

        if (userResult == null) {
            return IMOOCJSONResult.errorMsg("用户名或密码不正确");
        }

        userResult = setNullProperty(userResult);

        CookieUtils.setCookie(request, response, "user",
                JsonUtils.objectToJson(userResult), true);


        // TODO 生成用户token，存入redis会话
        // TODO 同步购物车数据

        return IMOOCJSONResult.ok(userResult);
    }

private Users setNullProperty(Users userResult) {
        userResult.setPassword(null);
        userResult.setMobile(null);
        userResult.setEmail(null);
        userResult.setCreatedTime(null);
        userResult.setUpdatedTime(null);
        userResult.setBirthday(null);
        return userResult;
    }
```

### Services

```java
@Transactional(propagation = Propagation.SUPPORTS)
    @Override
    public Users queryUserForLogin(String username, String password) {

//        try {
//            Thread.sleep(2500);
//        } catch (InterruptedException e) {
//            e.printStackTrace();
//        }

        Example userExample = new Example(Users.class);
        Example.Criteria userCriteria = userExample.createCriteria();

        userCriteria.andEqualTo("username", username);
        userCriteria.andEqualTo("password", password);

        Users result = usersMapper.selectOneByExample(userExample);

        return result;
    }
```

### Dao

```java
package com.imooc.mapper;

import com.imooc.my.mapper.MyMapper;
import com.imooc.pojo.Users;

public interface UsersMapper extends MyMapper<Users> {
}
```

## 显示用户信息

> 直接从cookie中获取

```js
created() {
				// var me = this;
				// 用户cookie操作
				var userCookie = app.getCookie("user");
				if (userCookie != null && userCookie != undefined && userCookie != '') {
					var userInfoStr = decodeURIComponent(userCookie);
					if (userInfoStr != null && userInfoStr != undefined && userInfoStr != '') {
						var userInfo = JSON.parse(userInfoStr);
						// 判断是否是一个对象
						if ( typeof(userInfo)  == "object" ) {
							this.userIsLogin = true;
							// console.log(userInfo);
							this.userInfo = userInfo;
						} else {
							this.userIsLogin = false;
							this.userInfo = {};
						}
					}
				} else {
					this.userIsLogin = false;
					this.userInfo = {};
				}
```

# 用户退出

## js

```js
logout() {
					var userId = this.userInfo.id;
					var serverUrl = app.serverUrl;

					axios.defaults.withCredentials = true;
					axios.post(serverUrl + '/passport/logout?userId=' + userId, {})
						.then(res => {
							if (res.data.status == 200) {
								window.location.href = "index.html";
							} else if (res.data.status == 500) {
								alert(res.data.msg);
								return;
							}
						});
				}
```

## Controller

```java

    @ApiOperation(value = "用户退出登录", notes = "用户退出登录", httpMethod = "POST")
    @PostMapping("/logout")
    public IMOOCJSONResult logout(@RequestParam String userId,
                                  HttpServletRequest request,
                                  HttpServletResponse response) {

        // 清除用户的相关信息的cookie
        CookieUtils.deleteCookie(request, response, "user");

        // TODO 用户退出登录，需要清空购物车
        // TODO 分布式会话中需要清除用户数据

        return IMOOCJSONResult.ok();
    }

```

# 整合Swagger

> 和前端对接
>
> ![image-20201109013201916](img/image-20201109013201916.png)

## 依赖

```xml
<!-- swagger2 配置 -->
<dependency>
	<groupId>io.springfox</groupId>
	<artifactId>springfox-swagger2</artifactId>
	<version>2.4.0</version>
</dependency>
<dependency>
	<groupId>io.springfox</groupId>
	<artifactId>springfox-swagger-ui</artifactId>
	<version>2.4.0</version>
</dependency>
	<dependency>
	<groupId>com.github.xiaoymin</groupId>
	<artifactId>swagger-bootstrap-ui</artifactId>
	<version>1.6</version>
</dependency>
```

## 配置Swagger

```java
@Configuration
@EnableSwagger2
public class Swagger2 {

//    http://localhost:8088/swagger-ui.html     原路径
//    http://localhost:8088/doc.html     原路径

    // 配置swagger2核心配置 docket
    @Bean
    public Docket createRestApi() {
        return new Docket(DocumentationType.SWAGGER_2)  // 指定api类型为swagger2
                    .apiInfo(apiInfo())                 // 用于定义api文档汇总信息
                    .select()
                    .apis(RequestHandlerSelectors
                            .basePackage("com.imooc.controller"))   // 指定controller包
                    .paths(PathSelectors.any())         // 所有controller
                    .build();
    }

    private ApiInfo apiInfo() {
        return new ApiInfoBuilder()
                .title("天天吃货 电商平台接口api")        // 文档页标题
                .contact(new Contact("imooc",
                        "https://www.imooc.com",
                        "abc@imooc.com"))        // 联系人信息
                .description("专为天天吃货提供的api文档")  // 详细信息
                .version("1.0.1")   // 文档版本号
                .termsOfServiceUrl("https://www.imooc.com") // 网站地址
                .build();
    }

}

```

## 访问

> 初始地址: http://localhost:8088/swagger-ui.html 
>
> 优化地址:http://localhost:8088/doc.html (需要引入美化依赖)

## 常用注解

### @ApiIgnore

> 忽略注解,将不会生成对应Controller文档

### @Api

> 用于生成文档

```java
@Api(value = "注册登录", tags = {"用于注册登录的相关接口"})
@RestController
@RequestMapping("passport")
public class PassportController {
```

###  @ApiOperation

> 用于解释方法

```java
@ApiOperation(value = "用户名是否存在", notes = "用户名是否存在", httpMethod = "GET")
    @GetMapping("/usernameIsExist")
    public IMOOCJSONResult usernameIsExist(@RequestParam String username) {

```

### @ApiModel

> 用于实体解释

```java
@ApiModel(value = "用户对象BO", description = "从客户端，由用户传入的数据封装在此entity中")
public class UserBO {
```

###  @ApiModelProperty

> 用于实体属性解释

```java

    @ApiModelProperty(value = "用户名", name = "username", example = "imooc", required = true)
    private String username;
    @ApiModelProperty(value = "密码", name = "password", example = "123456", required = true)
    private String password;
    @ApiModelProperty(value = "确认密码", name = "confirmPassword", example = "123456", required = false)
    private String confirmPassword;

```

# 使用Tomcat运行前端

> 直接把源码丢进webapp目录,运行就可以,后期我们江永Nigix运行前端.对于使用vue脚手架的前段项目.在安装了nodejs后可使用npm  install运行

![image-20201109015031738](img/image-20201109015031738.png)

# 跨域配置

> 前后端分离经常遇到跨域问题,跨域可以通过全局配置跨域.也可以在具体的Controller上使用@Crosorigin注解局部允许跨域

## 前后端联调配置

> 主要是该ip,让前端按钮基本能联通后端

### app.js

```js
window.app = {
    /* 开发环境 */
    // serverUrl: "http://localhost:8088",                                   // 接口服务接口地址
    // paymentServerUrl: "http://192.168.1.3:8089",                            // 支付中心服务地址
    // shopServerUrl: "http://localhost:8080/foodie-shop/",                  // 门户网站地址
    // centerServerUrl: "http://localhost:8080/foodie-center/",              // 用户中心地址
    // cookieDomain: "",                                                       // cookie 域

    /* 生产环境 */
    serverUrl: "http://api.z.mukewang.com:8088/foodie-dev-api",                      // 接口服务接口地址
    paymentServerUrl: "http://payment.t.mukewang.com/foodie-payment",       // 支付中心服务地址
    shopServerUrl: "http://shop.z.mukewang.com:8080/foodie-shop/",                            // 门户网站地址
    centerServerUrl: "http://center.z.mukewang.com:8080/foodie-center/",                        // 用户中心地址
    cookieDomain: ".z.mukewang.com;",                                       // cookie 域

    ctx: "/foodie-shop",

    getCookie: function (cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            // console.log(c)
            while (c.charAt(0) == ' ') c = c.substring(1);
                if (c.indexOf(name) != -1){
                    return c.substring(name.length, c.length);
                }
            }
        return "";
    },

    goErrorPage() {
        window.location.href = "http://www.imooc.com/error/noexists";
    },

    setCookie: function(name, value) {
        var Days = 365;
        var exp = new Date(); 
        exp.setTime(exp.getTime() + Days*24*60*60*1000);
        var cookieContent = name + "="+ encodeURIComponent (value) + ";path=/;";
        if (this.cookieDomain != null && this.cookieDomain != undefined && this.cookieDomain != '') {
            cookieContent += "domain=" + this.cookieDomain;
        }
        document.cookie = cookieContent;
        // document.cookie = name + "="+ encodeURIComponent (value) + ";path=/;domain=" + cookieDomain;//expires=" + exp.toGMTString();
    },

    deleteCookie: function(name) {
        var cookieContent = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        if (this.cookieDomain != null && this.cookieDomain != undefined && this.cookieDomain != '') {
            cookieContent += "domain=" + this.cookieDomain;
        }
        document.cookie = cookieContent;
    },

    getUrlParam(paramName) {
        var reg = new RegExp("(^|&)" + paramName + "=([^&]*)(&|$)");    //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);            //匹配目标参数
        if (r != null) return decodeURI(r[2]); return null;             //返回参数值
    },

    /**
	 * 构建购物车商品对象
	 */
	ShopcartItem: function(itemId, itemImgUrl, itemName, specId, specName, buyCounts, priceDiscount, priceNormal) {
		this.itemId = itemId;
		this.itemImgUrl = itemImgUrl;
		this.itemName = itemName;
        this.specId = specId;
        this.specName = specName;
        this.buyCounts = buyCounts;
        this.priceDiscount = priceDiscount;
        this.priceNormal = priceNormal;
    },

    addItemToShopcart(pendingItem) {
        // 判断有没有购物车，如果没有购物车，则new 一个购物车list
        // 如果有购物车，则直接把shopcartItem丢进去
        var foodieShopcartCookie = this.getCookie("shopcart");
        var foodieShopcart = [];
        if (foodieShopcartCookie != null && foodieShopcartCookie != "" && foodieShopcartCookie != undefined) {
            var foodieShopcartStr = decodeURIComponent(foodieShopcartCookie);
            foodieShopcart = JSON.parse(foodieShopcartStr);

            // 如果不是对象，则重新复制为空数组
            if (typeof(foodieShopcart) != "object") {
                foodieShopcart = [];
            }

            var isHavingItem = false;
            // 如果添加的商品已经存在与购物车中，则购物车中已经存在的商品数量累加新增的
            for(var i = 0 ; i < foodieShopcart.length ; i ++) {
                var tmpItem = foodieShopcart[i];
                var specId = tmpItem.specId;
                if (specId == pendingItem.specId) {
                    isHavingItem = true;
                    var newCounts = tmpItem.buyCounts + pendingItem.buyCounts;
                    tmpItem.buyCounts = newCounts;
                    // 删除主图在数组中的位置
                    foodieShopcart.splice(i, 1, tmpItem);
                }
            }   
            if (!isHavingItem) {
                foodieShopcart.push(pendingItem);
            }
        } else {
            foodieShopcart.push(pendingItem);
        }

        this.setCookie("shopcart", JSON.stringify(foodieShopcart));
    },

    /**
     * 获得购物车中的数量
     */
    getShopcartItemCounts() {
        // 判断有没有购物车，如果没有购物车，则new 一个购物车list
        // 如果有购物车，则直接把shopcartItem丢进去
        var foodieShopcartCookie = this.getCookie("shopcart");
        var foodieShopcart = [];
        if (foodieShopcartCookie != null && foodieShopcartCookie != "" && foodieShopcartCookie != undefined) {
            var foodieShopcartStr = decodeURIComponent(foodieShopcartCookie);
            foodieShopcart = JSON.parse(foodieShopcartStr);

            // 如果不是对象，则重新复制为空数组
            if (typeof(foodieShopcart) != "object") {
                foodieShopcart = [];
            }
        }
        return foodieShopcart.length;
    },

    /**
     * 获得购物车列表
     */
    getShopcartList() {
        // 判断有没有购物车，如果没有购物车，则new 一个购物车list
        // 如果有购物车，则直接把shopcartItem丢进去
        var foodieShopcartCookie = this.getCookie("shopcart");
        var foodieShopcart = [];
        if (foodieShopcartCookie != null && foodieShopcartCookie != "" && foodieShopcartCookie != undefined) {
            var foodieShopcartStr = decodeURIComponent(foodieShopcartCookie);
            foodieShopcart = JSON.parse(foodieShopcartStr);

            // 如果不是对象，则重新复制为空数组
            if (typeof(foodieShopcart) != "object") {
                foodieShopcart = [];
            }
        }
        return foodieShopcart;
    },

    checkMobile(mobile) {
        var myreg = /^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1}))+\d{8})$/;
        if (!myreg.test(mobile)) {
            return false;
        }
        return true;
    },
}

```

## 报错

![image-20201109015956444](img/image-20201109015956444.png)

## 配置 跨域

```java
@Configuration
public class CorsConfig {

    public CorsConfig() {
    }

    @Bean
    public CorsFilter corsFilter() {
        // 1. 添加cors配置信息
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedOrigin("http://localhost:8080");
        config.addAllowedOrigin("http://shop.z.mukewang.com:8080");
        config.addAllowedOrigin("http://center.z.mukewang.com:8080");
        config.addAllowedOrigin("http://shop.z.mukewang.com");
        config.addAllowedOrigin("http://center.z.mukewang.com");
        config.addAllowedOrigin("*");

        // 设置是否发送cookie信息
        config.setAllowCredentials(true);

        // 设置允许请求的方式
        config.addAllowedMethod("*");

        // 设置允许的header
        config.addAllowedHeader("*");

        // 2. 为url添加映射路径
        UrlBasedCorsConfigurationSource corsSource = new UrlBasedCorsConfigurationSource();
        corsSource.registerCorsConfiguration("/**", config);

        // 3. 返回重新定义好的corsSource
        return new CorsFilter(corsSource);
    }

}

```

# 整合Log4j

> 日志可用于调试,和监测等,SpringBoot默认引入了日志,所以要排除原有的log4j

![image-20201109020329702](img/image-20201109020329702.png)

## 移除默认日志  

```xml
<exclusions>
	<exclusion>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-logging</artifactId>
	</exclusion>
</exclusions>
```

## 添加日志框架依赖  

```xml
<!--引入日志依赖 抽象层 与 实现层-->
<dependency>
	<groupId>org.slf4j</groupId>
	<artifactId>slf4j-api</artifactId>
	<version>1.7.21</version>
</dependency>
	<dependency>
	<groupId>org.slf4j</groupId>
	<artifactId>slf4j-log4j12</artifactId>
	<version>1.7.21</version>
</dependency>
```

## 创建 log4j.properties 

>并且放到资源文件目录 src/main/resources  

```properties
log4j.rootLogger=DEBUG,stdout,file
log4j.additivity.org.apache=true
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.threshold=INFO
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%-5p %c{1}:%L - %m%n
log4j.appender.file=org.apache.log4j.DailyRollingFileAppender
log4j.appender.file.layout=org.apache.log4j.PatternLayout
log4j.appender.file.DatePattern='.'yyyy-MM-dd-HH-mm
log4j.appender.file.layout.ConversionPattern=%d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n
log4j.appender.file.Threshold=INFO
log4j.appender.file.append=true
log4j.appender.file.File=/workspaces/logs/foodie-api/mylog.log
```

# 通过日志监执行时间

> 可以通过日志监测,发送邮件,短信,记录错误 
>
> 需要借助Spring  Aop知识

## 引入aop依赖

```xml
<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-aop</artifactId>
</dependency>
```



## 利用环绕通知

```java
@Aspect
@Component
public class ServiceLogAspect {

    public static final Logger log =
            LoggerFactory.getLogger(ServiceLogAspect.class);

    /**
     * AOP通知：
     * 1. 前置通知：在方法调用之前执行
     * 2. 后置通知：在方法正常调用之后执行
     * 3. 环绕通知：在方法调用之前和之后，都分别可以执行的通知
     * 4. 异常通知：如果在方法调用过程中发生异常，则通知
     * 5. 最终通知：在方法调用之后执行
     */

    /**
     * 切面表达式：
     * execution 代表所要执行的表达式主体
     * 第一处 * 代表方法返回类型 *代表所有类型
     * 第二处 包名代表aop监控的类所在的包
     * 第三处 .. 代表该包以及其子包下的所有类方法
     * 第四处 * 代表类名，*代表所有类
     * 第五处 *(..) *代表类中的方法名，(..)表示方法中的任何参数
     *
     * @param joinPoint
     * @return
     * @throws Throwable
     */
    @Around("execution(* com.imooc.service.impl..*.*(..))")
    public Object recordTimeLog(ProceedingJoinPoint joinPoint) throws Throwable {

        log.info("====== 开始执行 {}.{} ======",
                        joinPoint.getTarget().getClass(),
                        joinPoint.getSignature().getName());

        // 记录开始时间
        long begin = System.currentTimeMillis();

        // 执行目标 service
        Object result = joinPoint.proceed();

        // 记录结束时间
        long end = System.currentTimeMillis();
        long takeTime = end - begin;

        if (takeTime > 3000) {
            log.error("====== 执行结束，耗时：{} 毫秒 ======", takeTime);
        } else if (takeTime > 2000) {
            log.warn("====== 执行结束，耗时：{} 毫秒 ======", takeTime);
        } else {
            log.info("====== 执行结束，耗时：{} 毫秒 ======", takeTime);
        }

        return result;
    }

}

```

# SpringBoot优雅的使用日志

## 引入Lombook插件依赖

```xml
<dependency>
 
    <groupId>org.projectlombok</groupId>
 
    <artifactId>lombok</artifactId>
 
    <version>1.16.18</version>
 
</dependency>
```

## 使用@Slf4j注解

> 安装了Lombook插件和使用了这个注解可以直接使用log记录日志而不需要构造全局log对象

## 日志输出到文件

>默认情况下，Spring Boot将日志输出到控制台，不会写到日志文件。
>
>使用 Spring Boot 喜欢在 application.properties 或 application.yml 配置，这样只能配置简单的场景，保存路径、日志格式等，复杂的场景（区分 info 和 error 的日志、每天产生一个日志文件等）满足不了，只能自定义配置

```properties
logging:
 
  pattern:
 
    #格式化，只能输出日期和内容
 
    console: "%d - %msg%n"
 
  #        配置日志输出位置
 
  path: D:/
 
  #      配置日志输出文件 ，指定文件名
 
  file: D:/test.log
```

>如果要编写除控制台输出之外的日志文件，则需在 application.properties 中设置 logging.file 或 logging.path 属性。
>
>logging.file ，设置文件，可以是绝对路径，也可以是相对路径。如： logging.file=my.log。
>
>logging.path ，设置目录，会在该目录下创建 spring.log 文件，并写入日志内容，如： logging.path=/var/log
>
>如果只配置 logging.file ，会在项目的当前路径下生成一个 xxx.log 日志文件。
>
>如果只配置 logging.path ，在 /var/log 文件夹生成一个日志文件为 spring.log

注：二者不能同时使用，如若同时使用，则只有 logging.file 生效

默认情况下，日志文件的大小达到 10MB 时会切分一次，产生新的日志文件，默认级别为： ERROR、WARN、INFO

复杂的场景需编写配置文件logback-spring.xml，在里面可以满足生产级别的要求。

# 开启Mybatis打印Sql

```properties
############################################################
#
# mybatis 配置
#
############################################################
mybatis:
  type-aliases-package: com.imooc.pojo          # 所有POJO类所在包路径
  mapper-locations: classpath:mapper/*.xml      # mapper映射文件
#  configuration:
#    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
```

